<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Lock Free Linked List | Keep it simple, but not simpler</title><style type=text/css>body{max-width:800px;margin:auto;padding:1em;line-height:1.5em}.menu{padding:0}.menu li{display:inline-block}.article-meta,.menu a{text-decoration:none;background:#eee;padding:5px;border-radius:5px}.menu,.article-meta,footer{text-align:center}.title{font-size:1.1em}footer a{text-decoration:none}hr{border-style:dashed;color:#ddd}pre{border:1px solid #ddd;box-shadow:5px 5px 5px #eee;padding:1em;overflow-x:auto}code{background:#f9f9f9}pre code{background:0 0}img,iframe,video{max-width:100%}main{hyphens:auto}blockquote{background:#f9f9f9;border-left:5px solid #ccc;padding:3px 1em}table{margin:auto;border-top:1px solid #666;border-bottom:1px solid #666}table thead th{border-bottom:1px solid #ddd}th,td{padding:5px}thead,tfoot,tr:nth-child(even){background:#eee}</style><style type=text/css>body{font-family:Optima,Candara,Calibri,Arial,sans-serif}code{font-family:lucida console,Monaco,monospace;font-size:85%}</style></head><body><nav><ul class=menu><li><a href=/>Home</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Lock Free Linked List</span></h1><h2 class=date>2019/10/27</h2></div><main><p>This is my first blog post. Through this blog I want to learn and explore different paradigms of programming and software development. So this blog will mostly be in format of notes of things which I have read and some of my thoughts around them. I will try to ensure that I always metion links which I have used to research on the topic.</p><p>On of my personal favorite paradigms in programming is asynchronous programming so wanted to start with a very basic lock free data structure &ldquo;Lock free linked list&rdquo;.</p><h3 id=what-does-lock-free-programming-mean>What does lock free programming mean ?</h3><p>Let&rsquo;s say we have some data which others can be read as well as change. Depending on the methods we provide to change the data we might leave data in in-consistent state. for example :-</p><p>Let&rsquo;s say we have a variable <code>int value = 0</code> and we provide a method to increment this value. Here is how code of &ldquo;increment&rdquo; method would look :-</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>increment</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Till time we call this method from one thread or one by one everything will be fine. Now lets say multiple threads start calling this method parallely. Here is java code for the same here we are calling &ldquo;increment&rdquo; method 10000 times. We are only using 2 threads so roughly each thread will call increment 5000 times.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>CompletableFuture</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>ExecutorService</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>Executors</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>IncrementTesting</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>Exception</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>int</span> <span style=color:#000>loopSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// You can change loop size to experiment.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// Ensure you use more than 1 thread.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>2</span><span style=color:#000;font-weight:700>);</span> 
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>workerTasks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>loopSize</span><span style=color:#000;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>loopSize</span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// Start work asynchronously.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>workerTasks</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>supplyAsync</span><span style=color:#000;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>increment</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>executor</span><span style=color:#000;font-weight:700>);</span> 
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// Wait for all async tasks to finish.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>allOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>workerTasks</span><span style=color:#000;font-weight:700>).</span><span style=color:#c4a000>join</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000>executor</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>increment</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>On running this code e would expect this programm to print &ldquo;10000&rdquo;, However here is output of this programme on my laptop :-</p><ol><li>Run number 1 - 9994</li><li>Run number 2 - 9992</li><li>Run umber 3 - 9997</li><li>Run number 4 - 9998</li></ol><p>In fact every run will give you a different output in some runs you can even get the desired &ldquo;10000&rdquo; value. If we see following are the things which are happening in method increment :-</p><ol><li>Read the current value.</li><li>Increase the value by one</li><li>Set this value to existing variable.</li></ol><p>If multiple threads are performing this action in parallel it might happen that a thread 1 (T1) has read the value and wants to increase it now another thread T2 reads this value before T1 fnishes setting the value in such cases value won&rsquo;t be increased in T2 as it has previous value.</p><p>Traditional way to solve this problem is by using locks. In java we can just make the method &ldquo;increment&rdquo; <a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html>synchronized</a>. This will ensure this method can only be called by one thread at a time. If multiple threads want to invoke this method they will automatically wait for this method to finish for active thread.</p><p>However locks/synchronization have a cost. In the above example second thread will always have to wait for first thread to finish, this effectively means that their is no advantage of using multiple threads as at all times their is only 1 method doing the work.</p><p>So general idea of lock free programming is - Minimize usage of locks by using <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>optimistic design</a>, <a href=https://en.wikipedia.org/wiki/Compare-and-swap>CAS</a> etc. We can never eliminate locks fully as lock free programming poses certain limitations on how a programme can be written.</p><h3 id=compare-and-swap-cas>Compare and swap (CAS)</h3><p>As per wikipedia &ldquo;CAS compares the contents of a memory location with a given input value and if input value is same as current value it modifies the contents of that memory location to a new given value.&rdquo;. So CAS can be imagined as function taking 3 arguments.</p><ol><li>memory location</li><li>expected value at the memory location</li><li>new value to set at memory location</li></ol><p>Also this function will return a boolean value which will be <code>true</code> in case value was set to new value and <code>false</code> in case value at memory location had already changed so set did not happen.</p><p>Most of modern CPU&rsquo;s support this operation by default i.e. In 1 operation you can compare value in a memory location and if found equal change it to a new value.</p><p>C++ provides this operation through <code>std::atomic_compare_exchange_strong</code> and Java provides this through &ldquo;AtomicInteger&rdquo;, &ldquo;AtomicBoolean&rdquo;, &ldquo;AtomicLong&rdquo; etc classes. If you look at &ldquo;compareAndSet&rdquo; method inside &ldquo;AtomicInteger&rdquo; it is calling &ldquo;Unsafe&rdquo; class of java to perform hardware specific operation.</p><p>Here is how out programme would look with compare and swap operation</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>CompletableFuture</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>ExecutorService</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>Executors</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>atomic</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>AtomicInteger</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>CASTesting</span>
<span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>static</span> <span style=color:#000>AtomicInteger</span> <span style=color:#000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicInteger</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>0</span><span style=color:#000;font-weight:700>);</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>main</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>args</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>throws</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>lang</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>Exception</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>int</span> <span style=color:#000>loopSize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>10000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// You can change loop size to experiment.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>ExecutorService</span> <span style=color:#000>executor</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>Executors</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>newFixedThreadPool</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>10</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>CompletableFuture</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Integer</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>workerTasks</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>loopSize</span><span style=color:#000;font-weight:700>];</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#000>loopSize</span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>workerTasks</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>supplyAsync</span><span style=color:#000;font-weight:700>(()</span> <span style=color:#ce5c00;font-weight:700>-&gt;</span> <span style=color:#000>increment</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>executor</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Start work asynchronously.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000>CompletableFuture</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>allOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>workerTasks</span><span style=color:#000;font-weight:700>).</span><span style=color:#c4a000>join</span><span style=color:#000;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// Wait for all async tasks to finish.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000>executor</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>shutdown</span><span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>increment</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>currentValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>intValue</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#8f5902;font-style:italic>// We need to keep doing this till compare and set is successful
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>currentValue</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>currentValue</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>1</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>currentValue</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>intValue</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>currentValue</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>No matter how many threads we use here we will always get 10,000 which is our desired value.</p><p>The only thing which has changed here is that we used &ldquo;AtomicIntger&rdquo; instead of primitive &ldquo;int&rdquo;. AtomicIntger provides us atomic compare and set operation. We then assign value on which we want to increment in a seperate variable and loop till our desired value is set.</p><p>Good thing here is that none of the threads will be blocked so their is no deadlock scenario to worry about. (Deadlock is a scenario when one thread is waiting for another thread to release a lock and that lock is never released or original thread dies while lock is still acquired. In such case original thread will keep on waiting. There are many other techniques to avoid this most common one being <code>wait with timeout</code> we can discuss this in another post.)</p><h3 id=linked-list>Linked list</h3><p>To allow arbitary insertion we will implement a sorted linked list this implemention can be easily modifed to create a normal linked list/stack/queue. Let&rsquo;s assume following structure of Node in the linked list :-</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000>Node</span> <span style=color:#000>next</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Let&rsquo;s consider an ordered linked list :-</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-no-highlight data-lang=no-highlight>+----------+    +-------+    +-------+   +-------+    +--------+
|   head   ------   1   ------  3    -----   7   ------  tail  |
+----------+    +-------+    +-------+   +-------+    +--------+                                                           </code></pre></div><p>In such a list insertion requires finding postion of the node i.e node after which this node should be inserted. Let&rsquo;s say we want to insert 5 in this list. It will require two operations making 7 as next node of 5 and then changing next node of 3 to 5.</p><p>Operation 1 :-</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-no-highlight data-lang=no-highlight>+----------+    +-------+    +-------+           +-------+      +--------+
|   head   ------   1   ------  3    -------------   7   --------   tail |
+----------+    +-------+    +-------+          /+-------+      +--------+
                                               /                          
                                              /                           
                                             /                            
                                            /                             
                                  +-------+/                              
                                  |   5   /                               
                                  +-------+                                 </code></pre></div><p>Operation 2 :-</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-no-highlight data-lang=no-highlight>+----------+    +-------+    +-------+ +-------+   +-------+    +--------+
|   head   ------   1   ------  3    ---  5    ----- 7     ------   tail |
+----------+    +-------+    +-------+ +-------+   +-------+    +--------+</code></pre></div><p>Operation 1 is safe and simple and can be done directly.</p><p>For Operation 2 we will need to use Compare and swap to change next of 3. CAS will ensure that swap only suceeds if next node of 3 is still 7 in case another insertion has happened i.e 6 has been inserted in parallel our initial CAS will fail, during next CAS attempt we will mark 6 as next node 5 and trying changing next node of 3 to 5. This will keep on going till CAS is not successful.</p><p>Similarly if we think of delete operation i.e we need to delete &ldquo;5&rdquo; then we will need to do following things :-</p><ol><li>Find the node which is just before the target node to delete, which would be &ldquo;3&rdquo;.</li><li>Change the value of next of this node, Here we would like to change next of &ldquo;3&rdquo; to &ldquo;7&rdquo;.</li></ol><p>We can use CAS to change next of &ldquo;3&rdquo; i.e change next of &ldquo;3&rdquo; to &ldquo;7&rdquo; only if current next is &ldquo;5&rdquo;. This appraoch misses an edge case which is what is another parallel insertion is happening between &ldquo;5&rdquo; and &ldquo;7&rdquo;. With this approach in case &ldquo;6&rdquo; was being inserted in parallel we would have skipped this node and list would no longer contain 6.</p><p>So single CAS can not detect that a parallel insertion and deletion operation is happening at a node.</p><p>Algorithm proposeed in Tim harris paper handles this case using two CAS operaations first one to mark node which will be deleted and second CAS operation to actually change the next node. After first operation node is said to be logically deleted and after second operation node is said to be physically deleted. Before any insertion or deletion happens we will always check if a node is logically deleted in case it is we would physically delete the node and then only perform our insertion and deletion operations.</p><p>Following is code for this.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000>java</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>concurrent</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>atomic</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>AtomicMarkableReference</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * Node represents single item in linked list. Here next pointer is atomic markable reference so that it can hold
</span><span style=color:#8f5902;font-style:italic> * additional boolean value if a node is logically deleted.
</span><span style=color:#8f5902;font-style:italic> *
</span><span style=color:#8f5902;font-style:italic> * one thing to note here is if next pointer is marked to true then it means current Node has been logically deleted.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Node</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000>AtomicMarkableReference</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Node</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>next</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Node</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicMarkableReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic> * utility object used for performing search operation on the list. This object will not be exposed outside this class.
</span><span style=color:#8f5902;font-style:italic> * for a given search operation following would be values of 2 fields of this object :-
</span><span style=color:#8f5902;font-style:italic> * 1. curr - first node with equal or greater value than search keyword.
</span><span style=color:#8f5902;font-style:italic> * 2. pred - previous node of curr.
</span><span style=color:#8f5902;font-style:italic> */</span>
<span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Window</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Node</span> <span style=color:#000>pred</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>Node</span> <span style=color:#000>curr</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#000>Window</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Node</span> <span style=color:#000>pred</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Node</span> <span style=color:#000>curr</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>curr</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>class</span> <span style=color:#000>LinkedList</span> <span style=color:#000;font-weight:700>{</span>

    <span style=color:#000>Node</span> <span style=color:#000>head</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000>Node</span> <span style=color:#000>tail</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>LinkedList</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>head</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>MIN_VALUE</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000>tail</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Integer</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>MAX_VALUE</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000>head</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>set</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tail</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Add a new element to linked list.
</span><span style=color:#8f5902;font-style:italic>     * @param value - value to add.
</span><span style=color:#8f5902;font-style:italic>     * @return - return false in case value is already present in list in such case insertion will be ignored. Else
</span><span style=color:#8f5902;font-style:italic>     * return true is value was inserted.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>boolean</span> <span style=color:#000>add</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Window</span> <span style=color:#000>window</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
            <span style=color:#8f5902;font-style:italic>// return false if value is already present.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span>
            <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>newNode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Node</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#000>newNode</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>AtomicMarkableReference</span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// Try setting next node of pred using CAS operation. In case CAS operation fails we will need to find
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// new window.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>pred</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>newNode</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span>
                <span style=color:#000;font-weight:700>}</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Remove an element from linked list.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param value - value to remove.
</span><span style=color:#8f5902;font-style:italic>     * @return - return true in case value was present in list and remove. return false in case value was not present
</span><span style=color:#8f5902;font-style:italic>     * in list.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>boolean</span> <span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Window</span> <span style=color:#000>window</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>find</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>

            <span style=color:#8f5902;font-style:italic>// in case value is not present in the list return false.
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span>
            <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>getReference</span><span style=color:#000;font-weight:700>();</span>

                <span style=color:#8f5902;font-style:italic>// try to logically delete the node by marking delete bit to true.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>logicallyDeleted</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>attemptMark</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// If logical deletion failed i.e someone already changed the next node try to search again.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>logicallyDeleted</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>continue</span><span style=color:#000;font-weight:700>;</span>
                <span style=color:#000;font-weight:700>}</span>

                <span style=color:#8f5902;font-style:italic>// physically delete the node. Even if this operation fails we are okay because we are physically
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// deleting the node during find operation anyways.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>pred</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>window</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>curr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>next</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * utility method to print the list.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>void</span> <span style=color:#000>debug</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>Node</span> <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>getReference</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#204a87;font-weight:700>final</span> <span style=color:#000>StringBuilder</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>StringBuilder</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;head -&gt; &#34;</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>tail</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#000;font-weight:700>).</span><span style=color:#c4a000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34; -&gt; &#34;</span><span style=color:#000;font-weight:700>);</span>
            <span style=color:#000>next</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>getReference</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000>System</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;tail&#34;</span><span style=color:#000;font-weight:700>).</span><span style=color:#c4a000>toString</span><span style=color:#000;font-weight:700>());</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>/**
</span><span style=color:#8f5902;font-style:italic>     * Method to find first node whose value is greater than or equal to value. This will return object with two
</span><span style=color:#8f5902;font-style:italic>     * properties :-
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * 1. curr - This represents first node whose value is greater than or equal to input.
</span><span style=color:#8f5902;font-style:italic>     * 2. pred - This is previous node of curr.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * With the following definition our search operation will always return some value as out tail is initialized with
</span><span style=color:#8f5902;font-style:italic>     * MaxInt which will be always greater than any input.
</span><span style=color:#8f5902;font-style:italic>     *
</span><span style=color:#8f5902;font-style:italic>     * @param value - keyword to search
</span><span style=color:#8f5902;font-style:italic>     * @return - window object.
</span><span style=color:#8f5902;font-style:italic>     */</span>
    <span style=color:#204a87;font-weight:700>private</span> <span style=color:#000>Window</span> <span style=color:#000>find</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// In case list is empty.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>getReference</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tail</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Window</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>head</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tail</span><span style=color:#000;font-weight:700>);</span>
        <span style=color:#000;font-weight:700>}</span>

        <span style=color:#000>Node</span> <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000>Node</span> <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000>Node</span> <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>

        <span style=color:#8f5902;font-style:italic>// default status of deleted bit.
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>boolean</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#000>deleteBit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>};</span>
<span style=color:#f57900>
</span><span style=color:#f57900>        retry:</span>
        <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>head</span><span style=color:#000;font-weight:700>;</span>
            <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>getReference</span><span style=color:#000;font-weight:700>();</span>

            <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                <span style=color:#8f5902;font-style:italic>// if successor is in logical deletion deleteBit will be set to &#34;true&#34; else it will remain &#34;false&#34;.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>deleteBit</span><span style=color:#000;font-weight:700>);</span>

                <span style=color:#8f5902;font-style:italic>// if node is logically deleted we should attempt to physically delete it.
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>deleteBit</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>0</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>boolean</span> <span style=color:#000>valueChanged</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>pred</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>compareAndSet</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>succ</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>);</span>
                    <span style=color:#8f5902;font-style:italic>// If physical deletion failed this means another operation is happening in parallel. Start the loop
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#8f5902;font-style:italic>// again.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>valueChanged</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                        <span style=color:#204a87;font-weight:700>continue</span> <span style=color:#000>retry</span><span style=color:#000;font-weight:700>;</span>
                    <span style=color:#000;font-weight:700>}</span>

                    <span style=color:#8f5902;font-style:italic>// If physical deletion was successful change to next value.
</span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#000;font-weight:700>;</span>
                    <span style=color:#000>succ</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>next</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>deleteBit</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#000;font-weight:700>}</span>

                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>current</span><span style=color:#000;font-weight:700>.</span><span style=color:#c4a000>value</span> <span style=color:#ce5c00;font-weight:700>&gt;=</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
                    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>Window</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pred</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>current</span><span style=color:#000;font-weight:700>);</span>
                <span style=color:#000;font-weight:700>}</span>

                <span style=color:#8f5902;font-style:italic>// search next node
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>pred</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>current</span><span style=color:#000;font-weight:700>;</span>
                <span style=color:#000>current</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>succ</span><span style=color:#000;font-weight:700>;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>

<span style=color:#000;font-weight:700>}</span></code></pre></div><p>I have tried adding as many comment as possible to make it easy to understand.</p><h3 id=references>References</h3><ol><li><a href=https://timharris.uk/papers/2001-disc.pdf>https://timharris.uk/papers/2001-disc.pdf</a> - Main paper upon which whole article is based (highly recommended)</li><li><a href=https://www.cs.cmu.edu/~410-s05/lectures/L31_LockFree.pdf>https://www.cs.cmu.edu/~410-s05/lectures/L31_LockFree.pdf</a></li><li><a href=http://15418.courses.cs.cmu.edu/spring2013/article/46>http://15418.courses.cs.cmu.edu/spring2013/article/46</a></li><li><a href=https://en.wikipedia.org/wiki/Non-blocking_linked_list>https://en.wikipedia.org/wiki/Non-blocking_linked_list</a></li><li><a href=https://en.wikipedia.org/wiki/Compare-and-swap>https://en.wikipedia.org/wiki/Compare-and-swap</a></li></ol></main><footer></footer></body></html>